name: Build Chrome Extension

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-extension:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build React components
      run: npm run build
      
    - name: Build Chrome Extension
      run: node scripts/build-extension.js
        
    - name: Create extension package
      run: |
        cd chrome-extension
        zip -r ../playwright-pom-generator-extension.zip .
        cd ..
        
    - name: Upload extension artifact
      uses: actions/upload-artifact@v4
      with:
        name: chrome-extension
        path: chrome-extension/
        
    - name: Upload extension ZIP
      uses: actions/upload-artifact@v4
      with:
        name: playwright-pom-generator-extension
        path: playwright-pom-generator-extension.zip
        
    - name: Create Release (on main/master push)
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: Playwright POM Generator v1.0.${{ github.run_number }}
        body: |
          ## Playwright POM Generator Chrome Extension
          
          ### üöÄ Features
          - Complete DOM scanning including shadow DOMs and iframes
          - AI-powered Page Object Model generation using OpenAI GPT-4
          - Smart locator generation with best practices
          - Custom prompt support for targeted generation
          - Copy and download generated TypeScript code
          
          ### üì¶ Installation
          1. Download `playwright-pom-generator-extension.zip`
          2. Extract the ZIP file
          3. Open Chrome and go to `chrome://extensions/`
          4. Enable "Developer mode"
          5. Click "Load unpacked" and select the extracted folder
          6. Set your OpenAI API key in the extension popup
          
          ### üîß Usage
          1. Navigate to any webpage
          2. Click the extension icon
          3. Click "Scan DOM" to analyze the page
          4. Optionally add a prompt (e.g., "only login form")
          5. Click "Generate POM" to create Playwright code
          6. Copy or download the generated TypeScript code
          
          Built with ‚ù§Ô∏è using Lovable
        files: |
          playwright-pom-generator-extension.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}